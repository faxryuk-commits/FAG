// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

// =============================================
// ПОЛЬЗОВАТЕЛИ И АУТЕНТИФИКАЦИЯ
// =============================================

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  phone         String?   @unique
  passwordHash  String?
  
  // Профиль
  name          String?
  avatar        String?
  
  // Роль: customer, merchant, admin
  role          String    @default("customer")
  
  // Статус
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false) // Email/телефон подтверждён
  
  // OAuth
  accounts      Account[]
  sessions      Session[]
  
  // Связи
  orders        Order[]
  addresses     UserAddress[]
  favorites     UserFavorite[]
  reviews       UserReview[]
  
  // Мерчант данные (если роль = merchant)
  merchantRestaurants MerchantRestaurant[]
  
  // Уведомления
  notifications Notification[]
  
  // Временные метки
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

// NextAuth.js - OAuth аккаунты
model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              String
  provider          String  // google, telegram, etc.
  providerAccountId String
  
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// NextAuth.js - Сессии
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  
  @@index([userId])
  @@map("sessions")
}

// NextAuth.js - Токены верификации
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Адреса доставки пользователя
model UserAddress {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String   // "Дом", "Работа"
  address   String
  lat       Float?
  lng       Float?
  
  entrance  String?  // Подъезд
  floor     String?  // Этаж
  apartment String?  // Квартира
  comment   String?  // Комментарий курьеру
  
  isDefault Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@map("user_addresses")
}

// Избранное авторизованного пользователя
model UserFavorite {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId String
  
  createdAt    DateTime @default(now())
  
  @@unique([userId, restaurantId])
  @@index([userId])
  @@map("user_favorites")
}

// Отзывы от авторизованных пользователей
model UserReview {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId String
  orderId      String?  // Привязка к заказу (опционально)
  
  rating       Int      // 1-5
  text         String?  @db.Text
  photos       String[]
  
  // Модерация
  isApproved   Boolean  @default(false)
  
  // Ответ владельца
  ownerResponse     String? @db.Text
  ownerResponseDate DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@map("user_reviews")
}

// =============================================
// МЕРЧАНТ СИСТЕМА
// =============================================

// Связь мерчантов с ресторанами
model MerchantRestaurant {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId String
  
  // Роль в ресторане
  role         String   @default("owner") // owner, manager, staff
  
  // Разрешения
  canEditMenu      Boolean @default(true)
  canViewOrders    Boolean @default(true)
  canManageOrders  Boolean @default(true)
  canViewAnalytics Boolean @default(true)
  canEditSettings  Boolean @default(true)
  
  // Статус
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@map("merchant_restaurants")
}

// Настройки ресторана для мерчанта
model RestaurantSettings {
  id              String   @id @default(cuid())
  restaurantId    String   @unique
  
  // Доставка
  deliveryEnabled Boolean  @default(true)
  deliveryRadius  Float?   // км
  deliveryMinOrder Float?  // Минимальная сумма заказа
  deliveryFee     Float?   // Стоимость доставки
  deliveryTime    String?  // "30-45 мин"
  
  // Самовывоз
  pickupEnabled   Boolean  @default(true)
  pickupDiscount  Float?   // Скидка на самовывоз %
  
  // Бронирование
  reservationEnabled Boolean @default(true)
  reservationDeposit Float?  // Залог за бронь
  tablesCount        Int?    // Количество столов
  
  // Оплата
  cashEnabled     Boolean  @default(true)
  cardEnabled     Boolean  @default(true)
  onlineEnabled   Boolean  @default(false) // Click, Payme
  
  // Уведомления
  orderNotifyPhone String?  // Телефон для SMS о заказах
  orderNotifyEmail String?  // Email для уведомлений
  orderNotifyTelegram String? // Telegram chat_id
  
  // Автоподтверждение заказов
  autoConfirmOrders Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("restaurant_settings")
}

// =============================================
// УВЕДОМЛЕНИЯ
// =============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // order_created, order_confirmed, order_ready, etc.
  title     String
  message   String   @db.Text
  
  // Связи
  orderId   String?
  restaurantId String?
  
  // Статус
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId, isRead])
  @@map("notifications")
}

// =============================================
// ПРОМОКОДЫ И СКИДКИ
// =============================================

model PromoCode {
  id           String   @id @default(cuid())
  code         String   @unique
  
  // Тип скидки
  discountType String   // percent, fixed
  discountValue Float   // 10 (%) или 5000 (сум)
  
  // Ограничения
  minOrderAmount Float?  // Минимальная сумма заказа
  maxDiscount    Float?  // Максимальная скидка
  usageLimit     Int?    // Лимит использований
  usageCount     Int     @default(0)
  perUserLimit   Int?    // Лимит на пользователя
  
  // Привязка
  restaurantId   String? // null = для всех
  
  // Срок действия
  validFrom      DateTime @default(now())
  validUntil     DateTime?
  
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  
  @@index([code])
  @@map("promo_codes")
}

// Использование промокодов
model PromoCodeUsage {
  id          String   @id @default(cuid())
  promoCodeId String
  userId      String?
  orderId     String
  
  discount    Float    // Сумма скидки
  
  createdAt   DateTime @default(now())
  
  @@index([promoCodeId])
  @@index([userId])
  @@map("promo_code_usages")
}

// =============================================
// РЕСТОРАНЫ
// =============================================

model Restaurant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  address     String
  city        String
  latitude    Float
  longitude   Float
  
  // Контакты
  phone       String?
  website     String?
  email       String?
  menuUrl     String?  // Ссылка на меню (если есть)
  
  // Время работы
  workingHours WorkingHours[]
  
  // Меню
  menuItems   MenuItem[]
  
  // Отзывы
  reviews     Review[]
  
  // Медиа
  images      String[] // URLs изображений
  
  // Метаданные
  rating      Float?   @default(0)
  ratingCount Int      @default(0)
  priceRange  String?  // $, $$, $$$, $$$$
  cuisine     String[] // Типы кухни
  
  // Источники данных
  source      String   // yandex, google, 2gis
  sourceId    String   // ID из источника
  sourceUrl   String?  // URL источника
  
  // Бренд/сеть для группировки
  brand       String?  // McDonald's, KFC, etc.
  
  // Статус
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  isArchived  Boolean  @default(false) // Архивированные (скрытые) записи
  
  // Географические данные
  country     String?  // Узбекистан, Россия, Казахстан
  region      String?  // Ташкентская область, Московская область
  district    String?  // Яккасарайский район, Мирзо-Улугбекский район
  
  // Временные метки
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastSynced  DateTime? // Последняя синхронизация с источником
  
  // Метаданные синхронизации
  syncMeta    RestaurantSyncMeta?
  
  @@index([city])
  @@index([country])
  @@index([region])
  @@index([district])
  @@index([source, sourceId])
  @@index([latitude, longitude])
  @@map("restaurants")
}

model WorkingHours {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  dayOfWeek    Int      // 0 = воскресенье, 1 = понедельник, ..., 6 = суббота
  openTime     String   // "09:00"
  closeTime    String   // "22:00"
  isClosed     Boolean  @default(false)
  
  @@unique([restaurantId, dayOfWeek])
  @@map("working_hours")
}

model MenuItem {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?  @db.Text
  price        Float?
  category     String?  // Закуски, Основные блюда, Десерты и т.д.
  image        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([restaurantId])
  @@map("menu_items")
}

// =============================================
// ЗАКАЗЫ И БРОНИРОВАНИЯ
// =============================================

model Order {
  id              String   @id @default(cuid())
  restaurantId    String
  
  // Пользователь (опционально, если авторизован)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  
  // Номер заказа для отображения
  orderNumber     String   @unique @default(cuid())
  
  // Тип заказа
  orderType       String   // delivery, pickup, reservation
  
  // Статус
  status          String   @default("pending") // pending, confirmed, preparing, ready, delivered, cancelled
  
  // Клиент
  customerName    String
  customerPhone   String
  customerEmail   String?
  
  // Адрес доставки (для delivery)
  deliveryAddress String?  @db.Text
  deliveryLat     Float?
  deliveryLng     Float?
  deliveryNotes   String?  // Комментарий к доставке
  
  // Бронирование (для reservation)
  reservationDate DateTime?
  reservationTime String?  // "19:00"
  guestsCount     Int?
  
  // Время самовывоза (для pickup)
  pickupTime      String?  // "19:30"
  
  // Позиции заказа
  items           OrderItem[]
  
  // Суммы
  subtotal        Float    // Сумма товаров
  deliveryFee     Float    @default(0)
  discount        Float    @default(0)
  total           Float    // Итоговая сумма
  
  // Оплата
  paymentMethod   String?  // cash, card, online
  isPaid          Boolean  @default(false)
  
  // Отслеживание
  visitorId       String?  // Из куки
  sessionId       String?
  
  // Временные метки
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  confirmedAt     DateTime?
  completedAt     DateTime?
  
  @@index([restaurantId])
  @@index([status])
  @@index([customerPhone])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String @id @default(cuid())
  orderId     String
  order       Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Позиция
  menuItemId  String?
  name        String
  price       Float
  quantity    Int    @default(1)
  
  // Модификаторы
  notes       String? // Без лука, острее и т.д.
  
  @@index([orderId])
  @@map("order_items")
}

model Review {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Основные данные
  rating       Int      // 1-5
  text         String?  @db.Text
  date         DateTime
  
  // Информация об авторе
  author       String   // Имя автора
  authorId     String?  // ID автора в источнике
  authorUrl    String?  // Ссылка на профиль автора
  authorAvatar String?  // URL аватара
  authorLevel  String?  // Уровень автора (Local Guide, Эксперт и т.д.)
  authorReviewsCount Int? // Сколько отзывов написал автор
  authorPhotosCount  Int? // Сколько фото загрузил автор
  isLocalGuide Boolean @default(false) // Google Local Guide
  
  // Медиа в отзыве
  photos       String[] // Фото приложенные к отзыву
  
  // Ответ владельца
  ownerResponse     String? @db.Text
  ownerResponseDate DateTime?
  
  // Метрики
  likesCount   Int      @default(0) // Полезность отзыва
  
  // Язык и перевод
  language     String?  // Язык отзыва
  translatedText String? @db.Text // Переведённый текст
  
  // Метаданные источника
  source       String   // yandex, google, 2gis, user
  sourceId     String?  // ID отзыва из источника
  sourceUrl    String?  // Ссылка на отзыв
  
  // Модерация
  isApproved   Boolean  @default(false)
  isVerified   Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([restaurantId])
  @@index([isApproved])
  @@index([authorId])
  @@index([rating])
  @@map("reviews")
}

model SyncJob {
  id          String   @id @default(cuid())
  source      String   // yandex, google, 2gis
  status      String   // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  error       String?  @db.Text
  stats       Json?    // Статистика синхронизации
  
  // Связь с запланированной задачей
  scheduledTaskId String?
  scheduledTask   ScheduledTask? @relation(fields: [scheduledTaskId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("sync_jobs")
}

// Запланированные задачи парсинга
model ScheduledTask {
  id             String   @id @default(cuid())
  source         String   // yandex, google, 2gis
  searchQuery    String
  location       String
  maxResults     Int      @default(50)
  
  // Расписание CRON
  cronExpression String   // "0 3 * * *" - каждый день в 3:00
  isActive       Boolean  @default(true)
  
  // Временные метки
  lastRun        DateTime?
  nextRun        DateTime?
  
  // История запусков
  syncJobs       SyncJob[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("scheduled_tasks")
}

// Webhook конфигурация
model WebhookConfig {
  id          String   @id @default(cuid())
  name        String
  url         String   // URL для отправки webhook
  secret      String?  // Секретный ключ для подписи
  
  // События для отправки
  events      String[] // ["sync.completed", "sync.failed", "restaurant.created"]
  
  isActive    Boolean  @default(true)
  
  // Статистика
  lastSent    DateTime?
  failCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("webhook_configs")
}

// Метаданные синхронизации ресторана (для умного обновления)
model RestaurantSyncMeta {
  id                String   @id @default(cuid())
  restaurantId      String   @unique
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Последние обновления разных типов данных
  lastBasicInfoSync DateTime?  // Адрес, телефон, координаты
  lastReviewsSync   DateTime?  // Отзывы и рейтинг
  lastPhotosSync    DateTime?  // Фотографии
  lastHoursSync     DateTime?  // Время работы
  
  // Хеши для проверки изменений
  basicInfoHash     String?
  reviewsHash       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("restaurant_sync_meta")
}

// Статистика использования API
model ApiUsage {
  id          String   @id @default(cuid())
  service     String   // google_places, apify
  endpoint    String   // place_details, text_search, etc.
  cost        Float    // Стоимость в USD
  
  // Период (месяц)
  year        Int
  month       Int
  
  // Счётчики
  requests    Int      @default(0)
  totalCost   Float    @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([service, endpoint, year, month])
  @@map("api_usage")
}

// История изменений ресторанов
model ChangeLog {
  id            String   @id @default(cuid())
  restaurantId  String
  
  // Тип операции
  action        String   // update, refresh, archive, restore, manual_edit
  
  // Источник изменения
  source        String   // google_api, manual, apify, system
  
  // Запрос
  requestType   String?  // basic, hours, photos, reviews, full
  requestData   Json?    // Данные запроса
  
  // Ответ
  responseData  Json?    // Данные ответа
  
  // Результат
  success       Boolean  @default(true)
  errorMessage  String?  @db.Text
  
  // Стоимость (если API)
  cost          Float?
  
  // Что изменилось
  changedFields String[] // ["rating", "phone", "workingHours"]
  
  createdAt     DateTime @default(now())
  
  @@index([restaurantId])
  @@index([createdAt])
  @@index([action])
  @@map("change_logs")
}

// =============================================
// АНАЛИТИКА - СОБЫТИЯ
// =============================================

// Основная таблица событий (Event Sourcing)
model AnalyticsEvent {
  id            String   @id @default(cuid())
  restaurantId  String?  // null для общих событий
  
  // Тип события
  eventType     String   // view, click, search, route, share, call, order, favorite
  
  // Детали события
  eventData     Json?    // Дополнительные данные события
  
  // Источник
  source        String   // web, mobile, widget, api
  platform      String?  // ios, android, desktop, tablet
  browser       String?  // chrome, safari, firefox
  
  // Пользователь (анонимный)
  sessionId     String   // UUID сессии
  visitorId     String?  // Fingerprint для повторных визитов
  
  // Геолокация пользователя
  userLat       Float?
  userLng       Float?
  userCity      String?
  userCountry   String?
  
  // Контекст
  searchQuery   String?  // Что искал пользователь
  referrer      String?  // Откуда пришёл
  utmSource     String?  // UTM метки
  utmMedium     String?
  utmCampaign   String?
  
  // Время
  createdAt     DateTime @default(now())
  dayOfWeek     Int?     // 0-6
  hourOfDay     Int?     // 0-23
  
  @@index([restaurantId])
  @@index([eventType])
  @@index([createdAt])
  @@index([sessionId])
  @@index([visitorId])
  @@map("analytics_events")
}

// =============================================
// АНАЛИТИКА - АГРЕГАТЫ (для быстрых запросов)
// =============================================

// Дневная статистика по ресторану
model RestaurantDailyStats {
  id            String   @id @default(cuid())
  restaurantId  String
  date          DateTime @db.Date
  
  // Просмотры и клики
  views         Int      @default(0)  // Просмотры в списке
  cardViews     Int      @default(0)  // Открытия карточки
  photoViews    Int      @default(0)  // Просмотры фото
  menuViews     Int      @default(0)  // Просмотры меню
  reviewViews   Int      @default(0)  // Просмотры отзывов
  
  // Действия
  calls         Int      @default(0)  // Звонки (клик по телефону)
  websiteClicks Int      @default(0)  // Переходы на сайт
  routeClicks   Int      @default(0)  // Построение маршрута
  shares        Int      @default(0)  // Поделились
  favorites     Int      @default(0)  // Добавили в избранное
  
  // Конверсии (если интегрировано)
  orders        Int      @default(0)  // Заказы
  reservations  Int      @default(0)  // Бронирования
  
  // Поисковая аналитика
  searchAppears Int      @default(0)  // Появления в поиске
  searchClicks  Int      @default(0)  // Клики из поиска
  
  // Уникальные пользователи
  uniqueVisitors Int     @default(0)
  newVisitors    Int     @default(0)
  returningVisitors Int  @default(0)
  
  // Вовлечённость
  avgTimeOnCard  Float?  // Среднее время на карточке (сек)
  bounceRate     Float?  // Процент отказов
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date])
  @@map("restaurant_daily_stats")
}

// Месячная статистика (для трендов)
model RestaurantMonthlyStats {
  id            String   @id @default(cuid())
  restaurantId  String
  year          Int
  month         Int
  
  // Суммарные показатели
  totalViews        Int   @default(0)
  totalCardViews    Int   @default(0)
  totalCalls        Int   @default(0)
  totalRoutes       Int   @default(0)
  totalShares       Int   @default(0)
  totalOrders       Int   @default(0)
  totalReservations Int   @default(0)
  
  // Уникальные пользователи
  uniqueVisitors    Int   @default(0)
  
  // Позиции
  avgSearchPosition Float? // Средняя позиция в поиске
  avgCategoryRank   Float? // Средняя позиция в категории
  
  // Сравнение с конкурентами (перцентиль)
  viewsPercentile   Float? // Какой % конкурентов обошли по просмотрам
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([restaurantId, year, month])
  @@index([restaurantId])
  @@map("restaurant_monthly_stats")
}

// =============================================
// АНАЛИТИКА - ПОИСКОВЫЕ ЗАПРОСЫ
// =============================================

// Популярные поисковые запросы
model SearchQuery {
  id            String   @id @default(cuid())
  query         String   // Текст запроса
  normalizedQuery String // Нормализованный (lowercase, trim)
  
  // Статистика
  searchCount   Int      @default(1)  // Сколько раз искали
  clickCount    Int      @default(0)  // Сколько раз кликнули на результат
  avgPosition   Float?   // Средняя позиция клика
  
  // Категории
  category      String?  // К какой категории относится
  intent        String?  // food, location, cuisine, dish, etc.
  
  // Время
  lastSearched  DateTime @default(now())
  createdAt     DateTime @default(now())
  
  @@unique([normalizedQuery])
  @@index([searchCount])
  @@index([category])
  @@map("search_queries")
}

// Связь запросов с ресторанами (что находят по запросу)
model SearchQueryRestaurant {
  id            String   @id @default(cuid())
  queryId       String
  restaurantId  String
  
  // Позиция в выдаче
  avgPosition   Float    @default(1)
  
  // Статистика
  impressions   Int      @default(0)  // Показы
  clicks        Int      @default(0)  // Клики
  ctr           Float?   // Click-through rate
  
  updatedAt     DateTime @updatedAt
  
  @@unique([queryId, restaurantId])
  @@index([restaurantId])
  @@map("search_query_restaurants")
}

// =============================================
// АНАЛИТИКА - КОНКУРЕНТЫ
// =============================================

// Анализ конкурентов (агрегированные данные района/категории)
model CompetitorAnalysis {
  id            String   @id @default(cuid())
  restaurantId  String
  
  // Период
  year          Int
  month         Int
  
  // Позиция среди конкурентов
  areaRank          Int?    // Позиция в районе
  categoryRank      Int?    // Позиция в категории
  cityRank          Int?    // Позиция в городе
  
  // Сравнительные показатели (% от среднего конкурента)
  viewsVsAvg        Float?  // Просмотры vs среднее
  ratingVsAvg       Float?  // Рейтинг vs среднее
  reviewsVsAvg      Float?  // Отзывы vs среднее
  
  // Рыночная доля в категории
  marketShare       Float?  // % просмотров от категории
  
  // Количество прямых конкурентов
  competitorsCount  Int?
  
  createdAt     DateTime @default(now())
  
  @@unique([restaurantId, year, month])
  @@index([restaurantId])
  @@map("competitor_analysis")
}

// =============================================
// АНАЛИТИКА - ОТЗЫВЫ (Sentiment Analysis)
// =============================================

// Анализ отзывов ресторана
model ReviewAnalysis {
  id            String   @id @default(cuid())
  restaurantId  String   @unique
  
  // Общий sentiment
  overallSentiment  Float?  // -1 до 1
  
  // Топ положительных тем
  positiveTopics    String[] // ["вкусная еда", "быстрое обслуживание"]
  
  // Топ негативных тем
  negativeTopics    String[] // ["долгое ожидание", "высокие цены"]
  
  // Часто упоминаемые блюда
  mentionedDishes   Json?    // { "плов": 45, "лагман": 32 }
  
  // Частые слова
  wordCloud         Json?    // { "вкусно": 120, "быстро": 85 }
  
  // Тренд рейтинга
  ratingTrend       String?  // up, down, stable
  ratingChange3m    Float?   // Изменение за 3 месяца
  
  // Скорость ответа владельца
  ownerResponseRate Float?   // % отзывов с ответом
  avgResponseTime   Float?   // Среднее время ответа (часы)
  
  updatedAt     DateTime @updatedAt
  
  @@map("review_analysis")
}

// =============================================
// АНАЛИТИКА - ПРОГНОЗЫ И РЕКОМЕНДАЦИИ
// =============================================

// AI-рекомендации для ресторана
model RestaurantInsights {
  id            String   @id @default(cuid())
  restaurantId  String   @unique
  
  // Оценка профиля (0-100)
  profileScore      Int?     // Насколько заполнен профиль
  photoScore        Int?     // Качество и количество фото
  descriptionScore  Int?     // Качество описания
  
  // Рекомендации
  recommendations   Json?    // [{ type: "add_photos", priority: "high", impact: "+15% views" }]
  
  // Прогнозы
  predictedViews    Int?     // Прогноз просмотров на месяц
  predictedCalls    Int?     // Прогноз звонков
  
  // Лучшее время для акций
  peakHours         Int[]    // Часы пиковой активности [12, 13, 19, 20]
  peakDays          Int[]    // Дни пиковой активности [5, 6] (сб, вс)
  
  // Сезонность
  seasonalTrend     Json?    // { "summer": 1.2, "winter": 0.8 }
  
  updatedAt     DateTime @updatedAt
  
  @@map("restaurant_insights")
}

// =============================================
// АНАЛИТИКА - ВОРОНКА КОНВЕРСИИ
// =============================================

// Воронка по дням
model ConversionFunnel {
  id            String   @id @default(cuid())
  restaurantId  String
  date          DateTime @db.Date
  
  // Этапы воронки
  searchImpressions Int  @default(0)  // 1. Показ в поиске
  listViews         Int  @default(0)  // 2. Просмотр в списке
  cardOpens         Int  @default(0)  // 3. Открытие карточки
  engagements       Int  @default(0)  // 4. Вовлечение (фото, меню, отзывы)
  intents           Int  @default(0)  // 5. Намерение (звонок, маршрут, сайт)
  conversions       Int  @default(0)  // 6. Конверсия (заказ, бронь)
  
  // Конверсии между этапами
  searchToList      Float? // % перехода 1→2
  listToCard        Float? // % перехода 2→3
  cardToEngage      Float? // % перехода 3→4
  engageToIntent    Float? // % перехода 4→5
  intentToConvert   Float? // % перехода 5→6
  
  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@map("conversion_funnels")
}

// =============================================
// ПОЛЬЗОВАТЕЛИ - ИЗБРАННОЕ
// =============================================

// Избранные рестораны пользователей
model Favorite {
  id            String   @id @default(cuid())
  restaurantId  String
  visitorId     String   // Анонимный ID пользователя
  
  createdAt     DateTime @default(now())
  
  @@unique([restaurantId, visitorId])
  @@index([visitorId])
  @@index([restaurantId])
  @@map("favorites")
}

