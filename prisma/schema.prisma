// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model Restaurant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  address     String
  city        String
  latitude    Float
  longitude   Float
  
  // Контакты
  phone       String?
  website     String?
  email       String?
  
  // Время работы
  workingHours WorkingHours[]
  
  // Меню
  menuItems   MenuItem[]
  
  // Отзывы
  reviews     Review[]
  
  // Медиа
  images      String[] // URLs изображений
  
  // Метаданные
  rating      Float?   @default(0)
  ratingCount Int      @default(0)
  priceRange  String?  // $, $$, $$$, $$$$
  cuisine     String[] // Типы кухни
  
  // Источники данных
  source      String   // yandex, google, 2gis
  sourceId    String   // ID из источника
  sourceUrl   String?  // URL источника
  
  // Статус
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  isArchived  Boolean  @default(false) // Архивированные (скрытые) записи
  
  // Страна для фильтрации
  country     String?  // UZ, RU, KZ, и т.д.
  
  // Временные метки
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastSynced  DateTime? // Последняя синхронизация с источником
  
  // Метаданные синхронизации
  syncMeta    RestaurantSyncMeta?
  
  @@index([city])
  @@index([source, sourceId])
  @@index([latitude, longitude])
  @@map("restaurants")
}

model WorkingHours {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  dayOfWeek    Int      // 0 = воскресенье, 1 = понедельник, ..., 6 = суббота
  openTime     String   // "09:00"
  closeTime    String   // "22:00"
  isClosed     Boolean  @default(false)
  
  @@unique([restaurantId, dayOfWeek])
  @@map("working_hours")
}

model MenuItem {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?  @db.Text
  price        Float?
  category     String?  // Закуски, Основные блюда, Десерты и т.д.
  image        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([restaurantId])
  @@map("menu_items")
}

model Review {
  id           String   @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Основные данные
  rating       Int      // 1-5
  text         String?  @db.Text
  date         DateTime
  
  // Информация об авторе
  author       String   // Имя автора
  authorId     String?  // ID автора в источнике
  authorUrl    String?  // Ссылка на профиль автора
  authorAvatar String?  // URL аватара
  authorLevel  String?  // Уровень автора (Local Guide, Эксперт и т.д.)
  authorReviewsCount Int? // Сколько отзывов написал автор
  authorPhotosCount  Int? // Сколько фото загрузил автор
  isLocalGuide Boolean @default(false) // Google Local Guide
  
  // Медиа в отзыве
  photos       String[] // Фото приложенные к отзыву
  
  // Ответ владельца
  ownerResponse     String? @db.Text
  ownerResponseDate DateTime?
  
  // Метрики
  likesCount   Int      @default(0) // Полезность отзыва
  
  // Язык и перевод
  language     String?  // Язык отзыва
  translatedText String? @db.Text // Переведённый текст
  
  // Метаданные источника
  source       String   // yandex, google, 2gis, user
  sourceId     String?  // ID отзыва из источника
  sourceUrl    String?  // Ссылка на отзыв
  
  // Модерация
  isApproved   Boolean  @default(false)
  isVerified   Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([restaurantId])
  @@index([isApproved])
  @@index([authorId])
  @@index([rating])
  @@map("reviews")
}

model SyncJob {
  id          String   @id @default(cuid())
  source      String   // yandex, google, 2gis
  status      String   // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  error       String?  @db.Text
  stats       Json?    // Статистика синхронизации
  
  // Связь с запланированной задачей
  scheduledTaskId String?
  scheduledTask   ScheduledTask? @relation(fields: [scheduledTaskId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("sync_jobs")
}

// Запланированные задачи парсинга
model ScheduledTask {
  id             String   @id @default(cuid())
  source         String   // yandex, google, 2gis
  searchQuery    String
  location       String
  maxResults     Int      @default(50)
  
  // Расписание CRON
  cronExpression String   // "0 3 * * *" - каждый день в 3:00
  isActive       Boolean  @default(true)
  
  // Временные метки
  lastRun        DateTime?
  nextRun        DateTime?
  
  // История запусков
  syncJobs       SyncJob[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("scheduled_tasks")
}

// Webhook конфигурация
model WebhookConfig {
  id          String   @id @default(cuid())
  name        String
  url         String   // URL для отправки webhook
  secret      String?  // Секретный ключ для подписи
  
  // События для отправки
  events      String[] // ["sync.completed", "sync.failed", "restaurant.created"]
  
  isActive    Boolean  @default(true)
  
  // Статистика
  lastSent    DateTime?
  failCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("webhook_configs")
}

// Метаданные синхронизации ресторана (для умного обновления)
model RestaurantSyncMeta {
  id                String   @id @default(cuid())
  restaurantId      String   @unique
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Последние обновления разных типов данных
  lastBasicInfoSync DateTime?  // Адрес, телефон, координаты
  lastReviewsSync   DateTime?  // Отзывы и рейтинг
  lastPhotosSync    DateTime?  // Фотографии
  lastHoursSync     DateTime?  // Время работы
  
  // Хеши для проверки изменений
  basicInfoHash     String?
  reviewsHash       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("restaurant_sync_meta")
}

